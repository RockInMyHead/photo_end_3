# Улучшения алгоритма кластеризации лиц

## Проблема
После распределения фотографий по лицам, иногда фотографии одного и того же человека попадают в разные папки.

## Внесенные улучшения

### 1. Более агрессивные пороги объединения
- **Увеличен margin**: с 0.05 до 0.12 для более агрессивного объединения
- **Снижен min_threshold**: с 0.2 до 0.12 для более мягкого минимального порога
- **Увеличен max_threshold**: с 0.4 до 0.5 для более высокого максимального порога
- **Улучшен авто-порог**: увеличен множитель margin с 2 до 3

### 2. Улучшенный алгоритм объединения кластеров
- **Дополнительная проверка для маленьких кластеров**: кластеры из 1-2 элементов объединяются при расстоянии < 0.4
- **Увеличен буфер объединения**: с 1.2 до 1.5 для более агрессивного слияния
- **Итеративное объединение**: добавлен второй этап объединения с еще более мягкими порогами (0.35)

### 3. Постобработка кластеров
- **Новая функция post_process_clusters**: дополнительная проверка и объединение очень похожих кластеров
- **Очень агрессивный порог**: 0.25 для финального объединения
- **Умное объединение групп**: правильная обработка множественных объединений

### 4. Улучшенное качество эмбеддингов
- **Снижен порог обнаружения лиц**: с 0.5 до 0.4 для лучшего обнаружения
- **Дополнительная проверка качества**: проверка на NaN, Inf и слишком малые значения
- **Улучшенная нормализация**: более строгая проверка качества эмбеддингов

### 5. Более мягкие параметры HDBSCAN
- **min_cluster_size**: 1 (позволяет кластерам из одного элемента)
- **min_samples**: 1 (минимальное количество образцов)
- **Более мягкая кластеризация**: позволяет лучше группировать похожие лица

## Результат
Эти улучшения должны значительно уменьшить количество случаев, когда фотографии одного человека распределяются по разным папкам, обеспечивая более точную группировку лиц.
